

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" runat="server">
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery-mobile-960.min.css" />
    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery.mobile-1.1.0.min.css" />
    <link rel="stylesheet" type="text/css" href="jquery.mobile-1.1.0/jquery.mobile.simpledialog.min.css" /> 

    <script src="jquery.mobile-1.1.0/jquery-1.7.1.min.js"></script>
    <script src="jquery.mobile-1.1.0/jquery.mobile-1.1.0.min.js"></script>
    <script type="text/javascript" src="jquery.mobile-1.1.0/jquery.mobile.simpledialog2.min.js"></script>

    <script language="javascript" type="text/javascript" src="SBODatabase.js"></script>


</head>

 <script language="javascript" type="text/javascript">

     var sDateArticulos = "", sDateClientes = "", sDateVentas = "", sDatePrecios = "", sDateAuxiliares = "";
     var xmlhttp = null;
     var xmlDoc;
     var xmlloaded = false;
     var myDb;
     var xmlprocess = "";
     var SlpCode = 0;


     $("#import").live("pageinit", function (event) {
         $.mobile.hidePageLoadingMsg();

         SlpCode = GetStorageValue("SlpCode");

         $('#toptitle').text("Importación Comercial " + SlpCode.toString());

         RefreshLastImportDates();
     });


     function RefreshLastImportDates() {

         myDB = OpenDatabase(successfunction, errorfunction);
         myDB.transaction(function (tx) {

             tx.executeSql("SELECT * FROM AX_IMPORT", [], function (tx, result) {
                 dataset = result.rows;

                 for (var i = 0; i < dataset.length; i++) {

                     var sProceso = result.rows.item(i)['Proceso'].toString();
                     var sLastImport = result.rows.item(i)['LastImport'].toString();

                     if (sProceso == "Articulos") sDateArticulos = sLastImport;
                     if (sProceso == "Clientes") sDateClientes = sLastImport;
                     if (sProceso == "Ventas") sDateVentas = sLastImport;
                     if (sProceso == "Precios") sDatePrecios = sLastImport;
                     if (sProceso == "Datos Auxiliares") sDateAuxiliares = sLastImport;
                 }

                 $("#LastDateArticulos").text(sDateArticulos);
                 $("#LastDateClientes").text(sDateClientes);
                 $("#LastDateVentas").text(sDateVentas);
                 $("#LastDatePrecios").text(sDatePrecios);
                 $("#LastDateAuxiliares").text(sDateAuxiliares);
                 $("#import").trigger("create");

             });
         });
     }

     function ImportFinished(sMsg) {
         $.mobile.hidePageLoadingMsg();
         alert(sMsg);
         RefreshLastImportDates();
     }

     function ImportArticulos() {
        showProcess("Importando Articulos");
        importXML("/SEGUI/IMPORT/" + SlpCode.toString() +"/articulos.xml", processItems);
    }

    function ImportClientes() {
        showProcess("Importando Clientes...");
        importXML("/SEGUI/IMPORT/" + SlpCode.toString() + "/clientes.xml", processClientes);
    }

    function ImportPrecios() {
        showProcess("Importando Precios...");
        importXML("/SEGUI/IMPORT/" + SlpCode.toString() + "/precios.xml", processPrices);
    }

    function ImportVentas() {
        xmlprocess = "Ventas";
        showProcess ("Importando Ventas...");
        importXML("/SEGUI/IMPORT/" + SlpCode.toString() + "/ventas.xml", processVentas);
    }

    function ImportAuxiliares() {
        showProcess("Importando Datos Auxiliares...");
        window.location.assign('ImportAuxiliares.aspx');
    }

    function showProcess(sMsg) {
         $.mobile.loadingMessageTextVisible = true;
        $.mobile.showPageLoadingMsg("a", sMsg, false);
    }
    

    //-----------------------------------------------------------------------------------------------
    // Articulos
    //-----------------------------------------------------------------------------------------------
     function processItems() {
         var i;
         var sItemCode, sItemName, sEanCode, sSalUnitMsr, sNumInSale, sItemType, sIVA, sRecEquivalencia, sPesoBruto, sPesoNeto, sPesoEscurrido
         var x, i, iImport = 0;

         try {

             var xNode = xmlhttp.responseXML.documentElement.getElementsByTagName("OITM");
             if (xNode.length > 0) {
                 myDB = OpenDatabase(successfunction, errorfunction);

                 myDB.transaction(
                        function (transaction) {

                            transaction.executeSql('DELETE  FROM AX_OITM', [], nullDataHandler, killTransaction);

                            for (i = 0; i < xNode.length; i++) {
                                sIVA = 0; sRecEquivalencia = 0; sPesoBruto = 0; sPesoNeto = 0; sPesoEscurrido = 0;

                                sItemCode = GetElement(xNode[i], "ItemCode");
                                sItemName = GetElement(xNode[i], "ItemName");
                                sEanCode = GetElement(xNode[i], "CodeBars");
                                sSalUnitMsr = GetElement(xNode[i], "SalUnitMsr");
                                sNumInSale = GetElement(xNode[i], "NumInSale");
                                sItemType = GetElement(xNode[i], "ItemType");
                                sIVA = GetNumericElement(xNode[i], "IVA");
                                sRecEquivalencia = GetNumericElement(xNode[i], "RecEquivalencia");
                                sPesoBruto = GetNumericElement(xNode[i], "PesoBruto");
                                sPesoNeto = GetNumericElement(xNode[i], "PesoNeto");
                                sPesoEscurrido = GetNumericElement(xNode[i], "PesoEscurrido");

                                if (sItemCode != "") {
                                    transaction.executeSql('INSERT INTO AX_OITM VALUES  (?, ?, ?,?, ?, ?,?, ?,?, ?)', [sItemCode, sItemName, sEanCode, sSalUnitMsr, sNumInSale, sIVA, sRecEquivalencia, sPesoBruto, sPesoNeto, sPesoEscurrido],
                                    nullDataHandler, errorfunction);

                                    iImport++;

                                }

                            }

                            transaction.executeSql("UPDATE AX_IMPORT SET LastImport=datetime( 'now' ) WHERE Proceso IN ('Articulos')", [],
                             nullDataHandler, killTransaction);

                            var sMsg = "Se han importado correctamente " + iImport.toString() + " articulos.";
                            ImportFinished(sMsg);



                        }
                 );
             }

         }
         catch (e) {
             errorfunction(e);

         }

     }



    //-----------------------------------------------------------------------------------------------
    // Clientes
    //-----------------------------------------------------------------------------------------------
     function processClientes() {
         var i;
         var sCardCode,sCardName,sAddress,sZipCode,sMailAddres,sMailZipCod,sNotes,sCity,sCountry
         var sMailCity,sMailCountr,sState1,sState2,sShipToDef,sLicTradNum,sBankCountr,sBillToDef,sRecEquivalencia
         var sZipCode,sBlock,sAddress2;
         var x, i, iImport = 0,iImportAdresses=0;

         try {
             var xNode = xmlhttp.responseXML.documentElement.getElementsByTagName("OCRD");
             var xNodeAdresses = xmlhttp.responseXML.documentElement.getElementsByTagName("CRD1");

             if (xNode.length > 0 || xNodeAdresses.length > 0) {

                 myDB = OpenDatabase(successfunction, errorfunction);

                 myDB.transaction(
                        function (transaction) {

                            if (xNode.length > 0) {

                                transaction.executeSql('DELETE  FROM AX_OCRD', [], nullDataHandler, killTransaction);

                                for (i = 0; i < xNode.length; i++) {
                                    sCardCode = GetElement(xNode[i], "CardCode");
                                    sCardName = GetElement(xNode[i], "CardName");
                                    sAddress = GetElement(xNode[i], "Address");
                                    sZipCode = GetElement(xNode[i], "ZipCode");
                                    sMailAddres = GetElement(xNode[i], "MailAddres");
                                    sMailZipCod = GetElement(xNode[i], "MailZipCod");
                                    sNotes = GetElement(xNode[i], "Notes");
                                    sCity = GetElement(xNode[i], "City");
                                    sCountry = GetElement(xNode[i], "Country");
                                    sMailCity = GetElement(xNode[i], "MailCity");
                                    sMailCountr = GetElement(xNode[i], "MailCountr");
                                    sState1 = GetElement(xNode[i], "State1");
                                    sState2 = GetElement(xNode[i], "State2");
                                    sShipToDef = GetElement(xNode[i], "ShipToDef");
                                    sLicTradNum = GetElement(xNode[i], "LicTradNum");
                                    sBankCountr = GetElement(xNode[i], "BankCountr");
                                    sBillToDef = GetElement(xNode[i], "BillToDef");
                                    sRecEquivalencia = GetElement(xNode[i], "RecEquivalencia");

                                    transaction.executeSql('INSERT INTO AX_OCRD VALUES  (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)', [sCardCode, sCardName, sLicTradNum, sAddress, sMailAddres, sMailZipCod, sCity, '', '', '', 'compras@clienteferrer.com', 'Josefa Gutierrez', 'DISTRIBUCION', 'A3'],
                                    nullDataHandler, killTransaction);

                                    iImport++;
                                }
                            }

                            if (xNodeAdresses.length > 0) {

                                transaction.executeSql('DELETE  FROM AX_CRD1', [], nullDataHandler, killTransaction);

                                for (i = 0; i < xNodeAdresses.length; i++) {

                                    sAddress2 = GetElement(xNodeAdresses[i], "Address");
                                    sCardCode = GetElement(xNodeAdresses[i], "CardCode");
                                    sStreet = GetElement(xNodeAdresses[i], "Street");
                                    sBlock = GetElement(xNodeAdresses[i], "Block");
                                    sZipCode = GetElement(xNodeAdresses[i], "ZipCode");
                                    sCity = GetElement(xNodeAdresses[i], "City");
                                    sCounty = GetElement(xNodeAdresses[i], "Name");
                                    sCountry = GetElement(xNodeAdresses[i], "Country");
                                    sLicTradNum = GetElement(xNodeAdresses[i], "LicTradNum");


                                    transaction.executeSql('INSERT INTO AX_CRD1 VALUES  (?, ?, ?, ?, ?, ?, ?, ?, ?)', [sAddress2, sCardCode, sStreet, sBlock, sZipCode, sCity, sCounty, sCountry, sLicTradNum],
                                    nullDataHandler, killTransaction);

                                    iImportAdresses++;
                                }
                            }

                            transaction.executeSql("UPDATE AX_IMPORT SET LastImport=datetime( 'now' ) WHERE Proceso IN ('Clientes')", [],
                             nullDataHandler, killTransaction);

                            var sMsg = "Se han importado correctamente " + iImport.toString() + " Clientes y " + iImportAdresses.toString() + " direcciones";
                            ImportFinished(sMsg);
                        }
                 );
             }
         }
         catch (e) {
             errorfunction(e);

         }

     }


     //-----------------------------------------------------------------------------------------------
     // Ventas
     //-----------------------------------------------------------------------------------------------
     function processVentas() {
         var i;
         var sItemCode, sItemName, sCardCode, sCardName, sQuantity, sStockSum;
         var x, i, iImport = 0;

         try {
                 var xNode = xmlDoc.documentElement.getElementsByTagName("VENTAS");
                 if (xNode.length > 0) {

                     myDB = OpenDatabase(successfunction, errorfunction);

                     myDB.transaction(
                        function (transaction) {

                            transaction.executeSql('DELETE  FROM AX_VENTAS', [], nullDataHandler, killTransaction);

                            for (i = 0; i < xNode.length; i++) {
                                sQuantity = 0; sStockSum = 0;

                                sCardCode = GetElement(xNode[i], "CardCode");
                                sCardName = GetElement(xNode[i], "CardName");
                                sItemCode = GetElement(xNode[i], "ItemCode");
                                sItemName = GetElement(xNode[i], "ItemName");
                                sQuantity = GetNumericElement(xNode[i], "Quantity");
                                sStockSum = GetNumericElement(xNode[i], "StockSum");

                                if (sItemCode != "" && sCardCode != "") {
                                    transaction.executeSql('INSERT INTO AX_VENTAS VALUES  (?, ?, ?,?, ?, ?,?)', [sCardCode, sCardName, sItemCode, sItemName, sQuantity, sStockSum, '2012-06-21'],
                                        nullDataHandler, killTransaction);

                                    iImport++;

                                }

                            }
                            transaction.executeSql("UPDATE AX_IMPORT SET LastImport=datetime( 'now' ) WHERE Proceso IN ('Ventas')", [],
                                nullDataHandler, killTransaction);

                            var sMsg = "Se han importado correctamente " + iImport.toString() + " ventas.";
                            setTimeout(ImportFinished(sMsg), 20000);

                        }
                     );
                 }
                 else {
                     ImportFinished("No se encontraron ventas para importar");
                 }
         }
         catch (e) {
             errorfunction(e);

         }

     }


 //-----------------------------------------------------------------------------------------------
 // Precios
 //-----------------------------------------------------------------------------------------------
   
    function processPrices(endfunction)
    {
    var i;
        var sItemCode,sItemName,sEanCode,sSalUnitMsr,sNumInSale,sItemType,sIVA,sRecEquivalencia,sPesoBruto,sPesoNeto,sPesoEscurrido
        var iImportPrices = 0;
        var i = 0;

        try {

            myDB = OpenDatabase(successfunction, errorfunction);

            myDB.transaction(
                function (transaction) {

                    transaction.executeSql('DELETE  FROM AX_PRECIOS', [], nullDataHandler, killTransaction);

                    var Xml2String = new XMLSerializer().serializeToString(xmlDoc);
                    var fileArray = Xml2String.split('\n')
                    var n = fileArray.length;

                    if (fileArray.length > 0) {

                        for (i = 0; i <= fileArray.length; i++) {
                            sPrecio = 0;

                            if (fileArray[i] == null) continue;
                            if (fileArray[i] == "") continue;

                            var fileLine = fileArray[i].split(';')

                            if (fileLine.length == 3) {

                                sItemCode = fileLine[0];
                                sCardCode = fileLine[1];

                                if (fileLine[2] != null)
                                    sPrecio = fileLine[2];


                                transaction.executeSql('INSERT INTO AX_PRECIOS VALUES  (?, ?, ?)', [sCardCode, sItemCode, sPrecio],
                                nullDataHandler, killTransaction);

                                iImportPrices++;
                            }
                        }
                    }
                    transaction.executeSql("UPDATE AX_IMPORT SET LastImport=datetime( 'now' ) WHERE Proceso IN ('Precios')", [],
                                nullDataHandler, killTransaction);
                    var sMsg = "Se han importado correctamente " + iImportPrices.toString() + " precios.";

                    setTimeout(ImportFinished(sMsg), 30000);
                    //ImportFinished(sMsg);
                }
            );
        }
        catch (e) {

            errorfunction(e);
        }


    }

     // ----------------------------------------------------------------------------------------
     // Importa un fichero XML mediante XMLHttpRequest de forma asincrona
     // ----------------------------------------------------------------------------------------
     function importXML(xmlfile,callbackfunction) {
         try {
             alert(xmlfile);
             xmlloaded = false;
             xmlhttp = new XMLHttpRequest();
             xmlhttp.onreadystatechange = statuschange;
             xmlhttp.open("GET", xmlfile, false );
         }
         catch (Exception) {
             var ie = (typeof window.ActiveXObject != 'undefined');

             if (ie) {
                 xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                 xmlDoc.async = false;
                 while (xmlDoc.readyState != 4) { };
                 xmlDoc.load(xmlfile);
                 callbackfunction();
                 xmlloaded = true;
             }
             else {
                 xmlDoc = document.implementation.createDocument("", "", null);
                 xmlDoc.onload = callbackfunction;
                 xmlDoc.load(xmlfile);
                 xmlloaded = true;
             }
         }

         if (!xmlloaded) {
             xmlhttp.setRequestHeader('Content-Type', 'text/xml')
             xmlhttp.send("");
             xmlDoc = xmlhttp.responseXML;
             callbackfunction();
             xmlloaded = true;
         }
     }

     // ----------------------------------------------------------------------------------------
     // statuschange
     // callback del procés de importació del fitxer
     // ----------------------------------------------------------------------------------------
     function statuschange() {

//         if (xmlhttp.readyState == 1) {
//             $("#logimport").append('<li>Se ha establecido conexión con el servidor</li>');
//             $("#logimport").listview("refresh");
//         }
//         if (xmlhttp.readyState == 2) {
//             $("#logimport").append('<li>El servidor ha recibido la petición</li>');
//             $("#logimport").listview("refresh");
//         }
//         if (xmlhttp.readyState == 3) {
//             $("#logimport").append('<li>Procesando petición</li>');
//             $("#logimport").listview("refresh");
//         }

         if (xmlhttp.readyState == 4) {


             if (xmlhttp.status == 200) {

//                 $("#logimport").append('<li>Se ha recibido correctamente el fichero</li>');
                 //                 $("#logimport").listview("refresh");

                 if (xmlprocess == "Ventas") {
                     var i = 1;
                 } 


             } else {
                 alert("Error importación : " + xmlhttp.statusText + "\nHTTP status code: " + xmlhttp.status);
             }
         }
     }


     function GetElement(Node, sElement) {
         var sValue = "";
         try {
             sValue = Node.getElementsByTagName(sElement)[0].childNodes[0].nodeValue;
         }
         catch (e) {

         }
         return sValue;
     }

     function GetNumericElement(Node, sElement) {
         var sValue = "0";
         try {
             sValue = Node.getElementsByTagName(sElement)[0].childNodes[0].nodeValue;
         }
         catch (e) {

         }
         return sValue;
     }

     function successfunction() {
         //$.mobile.hidePageLoadingMsg();
     }

     function errorfunction(e) {
         if (e == DOMException.INVALID_STATE_ERR) {

             alert("Invalid database version.");
         } else {
             alert("Unknown error " + e + ".");
         }
         $.mobile.hidePageLoadingMsg();
     }

     function GetStorageValue(sKey) {
         var value;
         value = localStorage[sKey];

         localStorage.removeItem(sKey);

         if (value == "null")
             value = null;

         return value;
     }


</script>

<body>



         <div data-role="page" data-theme="c" id ="import">

	         <div data-role="header">
	            <a href="javascript:window.location.assign('HerramientasMenu.html');" data-icon="back">Anterior</a>
	            <h1 id="toptitle">Importación</h1>
                <a href="javascript:window.location.assign('index.html');" data-icon="home">Inicio</a>
            </div>

	        <div data-role="content">	

                <ul data-role="listview" data-inset="true">
                    <li data-role="list-divider">Menú Importación</li>
                    <li data-role='list-divider' data-divider-theme='e' data-theme='a' >
                            <div class='container_12'>
                            <div class='grid_6'>Proceso</div> 
                            <div class='grid_6'>Ultima Importación</div> 
                        </div>
                    </li>
				    <li>
                       <a href="javascript:ImportArticulos();" data-ajax="false">
                         <div class='container_12'>
                            <div class='grid_6'>Articulos</div> 
                            <div class='grid_6' id ='LastDateArticulos'></div> 
                        </div>
                       </a>
                    </li>

                    <li>
                       <a href="javascript:ImportClientes();" data-ajax="false">
                         <div class='container_12'>
                            <div class='grid_6'>Clientes</div> 
                            <div class='grid_6' id ='LastDateClientes'></div> 
                        </div>
                       </a>
                    </li>

                    <li>
                       <a href="javascript:ImportVentas();" data-ajax="false">
                         <div class='container_12'>
                            <div class='grid_6'>Ventas</div> 
                            <div class='grid_6' id ='LastDateVentas'></div> 
                        </div>
                       </a>
                    </li>

                    <li>
                       <a href="javascript:ImportPrecios();" data-ajax="false">
                         <div class='container_12'>
                            <div class='grid_6'>Precios</div> 
                            <div class='grid_6' id ='LastDatePrecios'></div> 
                        </div>
                       </a>
                    </li>

                    <li>
                       <a href="javascript:ImportAuxiliares();" data-ajax="false">
                         <div class='container_12'>
                            <div class='grid_6'>Datos Auxiliares</div> 
                            <div class='grid_6' id ='LastDateAusiliares'></div> 
                        </div>
                       </a>
                    </li>

			    </ul>

                <div id ="msg"></div>

                <ul data-role="listview" id="logimport" data-inset="true" data-theme="e" data-mini="false">
                </ul>
 
     
            </div> 

              <div data-role="footer"  data-position="fixed" >
                    <div data-role="navbar" data-iconpos="top">
                        <ul>
                            <li><a href="javascript:window.location.assign('RuteroMenu.html');"  data-icon="back" >Rutero</a></li>
                            <li><a href="javascript:window.location.assign('VentasInicio.html');"  data-icon="plus" data-prefetch="true"  >Ventas/Visitas</a></li>
                            <li><a href="javascript:window.location.assign('ClientesGeneral.html');"  data-icon="back" >Interlocutores</a></li>
                            <li><a href="javascript:window.location.assign('Articulos.html');"  data-icon="back" >Articulos</a></li>
                        </ul>                
                </div>
            </div>

         </div>

</body>
 