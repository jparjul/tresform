
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" >
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>

    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery-mobile-960.min.css" />
    <link rel="stylesheet" href="jquery.mobile-1.2.0/jquery.mobile-1.2.0.min.css" />

    <script src="jquery.mobile-1.1.0/jquery-1.7.1.min.js"></script>
    <script src="jquery.mobile-1.2.0/jquery.mobile-1.2.0.min.js"></script>

    <script language="javascript" type="text/javascript" src="SBODatabase.js"></script>


</head>

 <script language="javascript" type="text/javascript">

     var myDB;
     var PedidosPendientes, VisitasPendientes, LeadsPendientes;
     var CheckClicked = false;
     var PedidosExportar;
     var TotalPedidosPendientes = 0;
     var xmldata = "";
     var xmlhttp = null;
     var xmlDoc;
     var xmlloaded = false;

 
     $("#listaexport").live("pageinit", function (event) {

         myDB = OpenDatabase(successfunction, errorfunction);

         $('#toptitle').text("Exportar Pedidos");

         RefreshPendientes();
         RefreshPedidosPendientes();

     });

     function RefreshAll() {
         RefreshPendientes();
         RefreshPedidosPendientes();
         $.mobile.hidePageLoadingMsg();
     }

     function RefreshPendientes() {

         VisitasPendientes = "Visitas (0)";
         PedidosPendientes = "Pedidos (0)";
         LeadsPendientes = "Leads (0)";

         myDB.transaction(function (tx) {

             tx.executeSql("select COUNT(*) AS Total FROM AX_VISITAS WHERE Send=?", [0], function (tx, result) {
                 VisitasPendientes = "Visitas (" + result.rows.item(0)['Total'].toString() + ")";
                 $('#countVisitas').text(VisitasPendientes);
             });
         });

         myDB.transaction(function (tx) {

             tx.executeSql("select COUNT(*) AS Total FROM AX_ORDR WHERE Send=?", [0], function (tx, result) {
                 PedidosPendientes = "Pedidos (" + result.rows.item(0)['Total'].toString() + ")";
                 TotalPedidosPendientes = result.rows.item(0)['Total'];
                 $('#countPedidos').text(PedidosPendientes);
             });
         });

         //$('#countLeads').text("Leads (" + LeadsPendientes.toString() + ")" );
     }

     function RefreshPedidosPendientes() {
         var sTextDiscount, dQuantity, dPrice, dDiscount, dTotalLinea;
         var iLine;
         var sTotal, sId, sVisita, sCliente, sNombre, sFecha;

         $.mobile.loadingMessageTextVisible = true;
         $.mobile.showPageLoadingMsg("a", "Inicializando Lineas...", false);

         myDB.transaction(function (tx) {

             tx.executeSql("select T0.*,T1.CardName from AX_ORDR T0 LEFT OUTER JOIN AX_OCRD T1 ON T0.CardCode = T1.CardCode WHERE T0.Send=?", [0], function (tx, result) {
                 dataset = result.rows;

                 $('#lvPedidos').empty();
                 $("#lvPedidos").append('<li data-role="list-divider"><div class="container_12"><div class="grid_1">Exp.</div><div class="grid_1">Pedido</div><div class="grid_2">Cliente</div><div class="grid_4">Nombre</div><div class="grid_2">Fecha</div><div class="grid_2">Total</div></div></li>');
                 // $("#lvPedidos").append('<li data-role="list-divider"><div class="container_12"><div class="grid_2">Pedido</div><div class="grid_2">Cliente</div><div class="grid_4">Nombre</div><div class="grid_2">Fecha</div><div class="grid_2">Total</div></div></li>');

                 PedidosExportar = new Array(result.rows.length);

                 for (var i = 0; i < result.rows.length; i++) {

                     sId = "";
                     sVisita = "";
                     sCliente = "";
                     sNombre = "";
                     sFecha = "";

                     iLine = i + 1;

                     try {
                         sId = result.rows.item(i)['Id'].toString();
                         sVisita = result.rows.item(i)['IdVisita'].toString();
                         sCliente = result.rows.item(i)['CardCode'].toString();
                         sNombre = result.rows.item(i)['CardName'].toString();
                         sFecha = result.rows.item(i)['Date'].toString();
                     }
                     catch (e) {
                     }

                     PedidosExportar[i] = new Array(2);
                     PedidosExportar[i][0] = sId;
                     PedidosExportar[i][1] = 0;

                     if (result.rows.item(i)['Total'] != null)
                         sTotal = result.rows.item(i)['Total'].toString();
                     else sTotal = "0";

                     //$("#lvPedidos").append('<li data-mini="true" ><img id="img' + iLine.toString() + '" src="images/nocheck.png" onclick="javascript:SetCheckPedido(' + iLine.toString() + ' )" style = "padding-left:10px; padding-bottom:2px;" /><a href="javascript:SelectPedido(\'' + sId + '\');" data-ajax="false"><div class="container_12"><div class="grid_2">' + sId.toString() + '</div><div class="grid_2">' + sCliente.toString() + '</div><div class="grid_4">' + sNombre.toString() + '</div><div class="grid_2">' + sFecha.toString() + '</div><div class="grid_2">' + sTotal.toString() + '</div></div></a></li>');
                     $("#lvPedidos").append('<li data-mini="true"><a href="javascript:SelectPedido(\'' + sId + '\');" data-ajax="false"><div class="container_12"><div class="grid_1"><img id="img' + iLine.toString() + '" src="images/nocheck.png" onmousedown="javascript:SetCheckPedido(event,' + iLine.toString() + ' )" style = "padding-left:10px; padding-bottom:2px;" /></div><div class="grid_1">' + sId.toString() + '</div><div class="grid_2">' + sCliente.toString() + '</div><div class="grid_4"><div class="ui-grid-a">' + sNombre.toString() + '</div></div><div class="grid_2">' + sFecha.toString() + '</div><div class="grid_2">' + sTotal.toString() + '</div></div></a></li>');
                     // $("#lvPedidos").append('<li data-mini="true" ><a href="javascript:SelectPedido(\'' + sId + '\');" data-ajax="false"><div class="container_12"><div class="grid_2">' + sId.toString() + '</div><div class="grid_2">' + sCliente.toString() + '</div><div class="grid_4">' + sNombre.toString() + '</div><div class="grid_2">' + sFecha.toString() + '</div><div class="grid_2">' + sTotal.toString() + '</div></div></a></li>');


                 }
                 $('#lvPedidos').listview('refresh', true);
                 $("#listaexport").trigger("create");
                 $.mobile.hidePageLoadingMsg();

             });
         });
     }

     function SelectPedido(sValue) {
         if (CheckClicked == false) {
             localStorage['PedidoEdit'] = sValue;
             window.location.assign("VentasPedidoEdicion.html");
         }
         else CheckClicked = false;
     }




     function SetCheckPedido(event,iLinea) {

         event.preventDefault();
         event.stopPropagation();
         CheckClicked = true;

         if ($('#img' + iLinea.toString()).attr('src') == 'images/check.png') {
             $('#img' + iLinea.toString()).attr('src', 'images/nocheck.png');
             PedidosExportar[iLinea - 1][ 1] = 0;
         }
         else {
             $('#img' + iLinea.toString()).attr('src', 'images/check.png');
             PedidosExportar[iLinea - 1][1] = 1;
         }

         return false;  
     }

     function CheckPedido(iLinea) {
         $('#img' + iLinea.toString()).attr('src', 'images/check.png');
         PedidosExportar[iLinea - 1][1] = 1;
         return false;
     }

     function UncheckPedido(iLinea) {
         $('#img' + iLinea.toString()).attr('src', 'images/nocheck.png');
         PedidosExportar[iLinea - 1][1] = 0;
         return false;
     }

     $(document).delegate('#CheckAll', 'click', function () {
         var i;

         for (i = 1; i <= $('#lvPedidos').children("li").length; i++) {
             CheckPedido(i)
         }
     })

     $(document).delegate('#UncheckAll', 'click', function () {
         var i;

         for (i = 1; i <= $('#lvPedidos').children("li").length; i++) {
             UncheckPedido(i)
         }
     })

     $(document).delegate('#Export', 'click', function () {
         var i;
         var sXml;
         var iCount = 0;
         var iPedido = 0;
         var sSelectPedidos = "";

         if (window.navigator.onLine == false) {
             alert("No es posible realizar la exportación. No dispone de conexión.");
             return;
         }

         xmldata = "<NewDataSet>";

         for (i = 0; i < TotalPedidosPendientes; i++) {
             if (PedidosExportar[i][1] == 1) {
                 iCount++;
                 sSelectPedidos += (PedidosExportar[i][0] + ",");
             }
         }

         if (iCount == 0) {
             alert("Debe seleccionar los Pedidos a exportar.");
             return;
         }

         sSelectPedidos = sSelectPedidos.substring(0, sSelectPedidos.length - 1);

         if (!confirm('Desea exportar los Pedidos Seleccionados?'))
             return;

         showProcess("Exportando Pedidos...");

         myDB.transaction(function (tx) {

             var sSQL = "SELECT * FROM AX_ORDR WHERE Id IN (" + sSelectPedidos + ")";
             tx.executeSql(sSQL, [], function (tx, result) {
                 dataset = result.rows;

                 for (var j = 0; j < result.rows.length; j++) {

                     xmldata += "<ORDR>";
                     xmldata += "<Id>" + result.rows.item(j)['Id'].toString() + "</Id>";
                     xmldata += "<CardCode>" + result.rows.item(j)['CardCode'].toString() + "</CardCode>";
                     xmldata += "<Date>" + result.rows.item(j)['Date'].toString() + "</Date>";
                     xmldata += "<DueDate>" + result.rows.item(j)['DueDate'].toString() + "</DueDate>";

                     if (result.rows.item(j)['Total'] != null)
                         xmldata += "<Total>" + result.rows.item(j)['Total'].toString() + "</Total>";
                     else
                         xmldata += "<Total>0</Total>";

                     if (result.rows.item(j)['Address'] != null) {
                         var sDir = result.rows.item(j)['Address'];
                         sDir = sDir.replace("&", "&amp;").replace("'", "&apos;").replace("<", "&lt;").replace(">", "&gt;").replace('"', "`").replace("`", "&apos;");
                         xmldata += "<Dir>" + sDir + "</Dir>";
                     }
                     else
                         xmldata += "<Dir></Dir>";

                     if (result.rows.item(j)['Comments'] != null) {
                         var sObs = result.rows.item(j)['Comments'];
                         sObs = sObs.replace("&", "&amp;").replace("'", "&apos;").replace("<", "&lt;").replace(">", "&gt;").replace('"', "`").replace("`", "&apos;");
                         xmldata += "<Obs>" + result.rows.item(j)['Comments'].toString() + "</Obs>";
                     }
                     else
                         xmldata += "<Obs></Obs>";

                     xmldata += "</ORDR>";
                 }

             });

             var sSQLin = "SELECT * FROM AX_RDR1 WHERE IdOrdr IN (" + sSelectPedidos + ")";
             tx.executeSql(sSQLin, [], function (tx, result) {
                 dataset = result.rows;
                 for (var j = 0; j < result.rows.length; j++) {

                     xmldata += "<RDR1>";
                     xmldata += "<Id>" + result.rows.item(j)['IdOrdr'].toString() + "</Id>";
                     xmldata += "<Code>" + result.rows.item(j)['ItemCode'].toString() + "</Code>";

                     if (result.rows.item(j)['Quantity'] != null)
                         xmldata += "<Qty>" + result.rows.item(j)['Quantity'].toString() + "</Qty>";
                     else
                         xmldata += "<Qty>0</Qty>";

                     if (result.rows.item(j)['QuantityFree'] != null)
                         xmldata += "<Qty0>" + result.rows.item(j)['QuantityFree'].toString() + "</Qty0>";
                     else
                         xmldata += "<Qty0>0</Qty0>";

                     if (result.rows.item(j)['Price'] != null)
                         xmldata += "<Price>" + result.rows.item(j)['Price'].toString() + "</Price>";
                     else
                         xmldata += "<Price>0</Price>";

                     xmldata += "</RDR1>";
                 }

                 //UpdateOrdersSend(sSelectPedidos, GotoExport, errorfunction);
                 GotoExport();

             });

         });

     })

     function showProcess(sMsg) {
         $.mobile.loadingMessageTextVisible = true;
         $.mobile.showPageLoadingMsg("a", sMsg, false);
     }

     function GotoExport() {
          xmldata += "</NewDataSet>";

          xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = statuschange;
          xmlhttp.open("POST", "ExportacionPedidos.aspx", true);
          xmlhttp.setRequestHeader('Content-Type', 'text/xml')
          xmlhttp.send(xmldata);


      }

      // ----------------------------------------------------------------------------------------
      // statuschange
      // callback del procés de importació xml
      // ----------------------------------------------------------------------------------------
      function statuschange() {
          var sDate = "";
          var sTotal = "";

          if (xmlhttp.readyState == 4) {
              if (xmlhttp.status == 200) {

                  var sInsertPedidos = xmlhttp.responseText;

                  if (sInsertPedidos.toString() == "")
                      alert("Error en la exportación de Pedidos");
                  else {
                       UpdateOrdersSend(sInsertPedidos, endfunction(sInsertPedidos), errorfunction);
                  }

                  $.mobile.hidePageLoadingMsg();


              } else {
                  alert("Error exportación : " + xmlhttp.statusText + "\nHTTP status code: " + xmlhttp.status);
              }
          }
      }

      function endfunction(sInsertPedidos) {

          setTimeout(alert("Se han exportado correctamente los Pedidos seleccionados " + sInsertPedidos), 1000);

          setTimeout(RefreshAll, 1000);
      }

     function successfunction() {
         $.mobile.hidePageLoadingMsg();
     }

     function errorfunction(e) {
         if (e == DOMException.INVALID_STATE_ERR) {

             alert("Invalid database version.");
         } else {
             alert("Unknown error " + e + ".");
         }
         $.mobile.hidePageLoadingMsg();
     }
</script>

<body>



         <div data-role="page" data-theme="c" id="listaexport">

	         <div data-role="header">
	            <a href="javascript:window.location.assign('index.html');" data-icon="home">Inicio</a>
	            <h1 id="toptitle">Exportar Pedidos</h1>
            </div>

           <div data-role="navbar">
	            <ul>
		            <li><a href="javascript:window.location.assign('HerramientasExportPedidos.html');" data-ajax ="false" class="ui-btn-active ui-state-persist"><div id ="countPedidos">Pedidos (0)</div></a></li>
                    <li><a href="javascript:window.location.assign('HerramientasExportVisitas.html');" data-ajax ="false" ><div id ="countVisitas">Visitas (0)</div></a></li>
                    <li><a href="javascript:window.location.assign('HerramientasExportLeads.html¨');" data-ajax ="false" ><div id ="countLeads">Leads (0)</div></a></li>
	            </ul>
            </div>

	        <div data-role="content">	

                         <ul data-role="listview" data-inset="true" id= "lvPedidos" data-divider-theme ="c" data-mini="false" >

                        
                         </ul>


                  <ul data-role="listview" data-inset="true" id= "Ul2">
                    <li class="ui-body ui-body-b">
				        <fieldset class="ui-grid-b">
						        <div data-theme="b" class="ui-block-a"><button id="CheckAll" data-theme="d">Marcar todo</button></div>
						        <div data-theme="c" class="ui-block-b"><button id="UncheckAll" data-theme="d">Desmarcar todo</button></div>
                                <div data-theme="c" class="ui-block-c"><button  id="Export" data-theme="a" >Exportar</button></div>
			            </fieldset>
			        </li>

			    </ul>
            </div> 

               <div data-role="footer"  data-position="fixed" >
                    <div data-role="navbar" data-iconpos="top">
                        <ul>
                            <li><a href="javascript:window.location.assign('RuteroMenu.html');"  data-icon="back" >Rutero</a></li>
                            <li><a href="javascript:window.location.assign('VentasInicio.html');"  data-icon="plus" data-prefetch="true"  >Ventas/Visitas</a></li>
                            <li><a href="javascript:window.location.assign('ClientesGeneral.html');"  data-icon="back" >Interlocutores</a></li>
                            <li><a href="javascript:window.location.assign('Articulos.html');"  data-icon="back" >Articulos</a></li>
                        </ul>                
                </div>

         </div>



</body>
 
 

</html>