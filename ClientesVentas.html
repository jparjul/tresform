
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" runat="server">
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery-mobile-960.min.css" />
    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery.mobile-1.1.0.min.css" />
    <script src="jquery.mobile-1.1.0/jquery-1.7.1.min.js"></script>
    <script src="jquery.mobile-1.1.0/jquery.mobile-1.1.0.min.js"></script>

    <script language="javascript" type="text/javascript" src="SBODatabase.js"></script>


</head>

  <script type="text/javascript">

      var Cliente = null;
      var Pedido = null;
      var NombreCliente = null;




      $("#pageventas").live("pageinit", function (event) {

          Cliente = GetStorageValue("Cliente");
          NombreCliente = GetStorageValue("NombreCliente");

          $('#txtCliente').text(Cliente);
          $('#txtNombreCliente').text(NombreCliente);

          Pedido = GetStorageValue("Pedido");

          if (Pedido != null) {

              RefreshLineas();
          }

      });


      function RefreshLineas() {
          var sTextDiscount, dQuantity, dPrice, dDiscount, dTotalLinea;

          $.mobile.loadingMessageTextVisible = true;
          $.mobile.showPageLoadingMsg("a", "Inicializando Lineas...", false);

          TotalBruto = 0; TotalPedido = 0; TotalNeto = 0; TotalDescuento = 0; TotalImpuesto = 0;

          myDB = OpenDatabase(successfunction, errorfunction);

          myDB.transaction(function (tx) {

              tx.executeSql("SELECT Id,ItemCode,ItemName,Quantity,Price, DiscPrcnt FROM AX_RDR1 WHERE IdOrdr = ?", [Pedido], function (tx, result) {
                  dataset = result.rows;

                  $('#lvLineas').empty();
                  $("#lvLineas").append('<li data-role="list-divider" data-mini="true"><div class="container_16"><div class="grid_2">Código</div><div class="grid_6">Descripción</div><div class="grid_2">Cantidad</div><div class="grid_2">PVP</div><div class="grid_2">Dto.</div></div></li>');

                  for (var i = 0; i < dataset.length; i++) {

                      var sId = result.rows.item(i)['Id'].toString();
                      var sItem = result.rows.item(i)['ItemCode'].toString();
                      var sName = result.rows.item(i)['ItemName'].toString();
                      var sQuantity = result.rows.item(i)['Quantity'].toString();
                      var sPrice = result.rows.item(i)['Price'].toString();
                      var sDiscount = result.rows.item(i)['DiscPrcnt'].toString();
                      if (sDiscount == "0") sTextDiscount = "";
                      else sTextDiscount = sDiscount + "%";

                      dQuantity = parseFloat(sQuantity);
                      dPrice = parseFloat(sPrice);
                      dDiscount = parseFloat(sDiscount);

                      $("#lvLineas").append('<li id=Line' + i.toString() + '><a href="index.html"><div class="container_12"><div class="grid_2">' + sItem.toString() + '</div><div class="grid_5">' + sName.toString() + '</div><div class="grid_2">' + sQuantity.toString() + '</div><div class="grid_2">' + sPrice.toString() + '</div><div class="grid_1">' + sTextDiscount.toString() + '</div></div></a><a href="javascript:DeleteLine(' + sId.toString() + ')" data-rel="dialog" data-transition="slideup"></a></li>');

                      dTotalLinea = (dQuantity * dPrice);
                      if (dDiscount > 0) dTotalLinea = dTotalLinea * (1 - (dDiscount / 100));

                      TotalBruto += dTotalLinea;
                  }
                  $('#lvLineas').listview('refresh', true);
                  RefreshTotales();

                  $("#detalle1").trigger("create");

              });
          });
      }

      function RefreshTotales() {
          $('#lvTotales').empty();
          $("#lvTotales").append('<li data-role="list-divider"><div class="container_12"><div class="grid_2">Subtotal</div><div class="grid_4">% Dto </div><div class="grid_2">Base</div><div class="grid_2">Impuesto</div><div class="grid_2">Total</div></div></li>');
          $("#lvTotales").append('<li><div class="container_12"><div class="grid_2">' + TotalBruto.toFixed(2).toString() + '</div><div class="grid_5">' + TotalDescuento.toFixed(2).toString() + '</div><div class="grid_2">' + TotalNeto.toFixed(2).toString() + '</div><div class="grid_2">' + TotalImpuesto.toFixed(2).toString() + '</div><div class="grid_1">' + TotalBruto.toFixed(2).toString() + '</div></div></li>');
          $('#lvTotales').listview('refresh', true);
          // $("#detalle1").trigger("create");

      }

      function queryString(parameter) {
          var loc = location.search.substring(1, location.search.length);
          var param_value = false;
          var params = loc.split("&");
          for (i = 0; i < params.length; i++) {
              param_name = params[i].substring(0, params[i].indexOf('='));
              if (param_name == parameter) {
                  param_value = params[i].substring(params[i].indexOf('=') + 1)
              }
          }
          if (param_value) {
              return param_value;
          }
          else {
              return null; //Here determine return if no parameter is found
          }
      }

      function successfunction() {
          $.mobile.hidePageLoadingMsg();
      }

      function errorHandler(transaction, error) {
          Alert(error.message + ' (Code ' + error.code + ')');
          return true;
      }

      function nullDataHandler(transaction, results) {
      }

      function errorfunction(e) {
          if (e == DOMException.INVALID_STATE_ERR) {

              Alert("Invalid database version.");
          } else {
              Alert("Unknown error " + e + ".");
          }
          $.mobile.hidePageLoadingMsg();
      }

      function GetStorageValue(sKey) {
          var value;
          value = localStorage[sKey];
          //localStorage[sKey] = null; 
          localStorage.removeItem(sKey);

          if (value == "null")
              value = null;

          return value;
      }

      function GotoSeleccionPedido() {
          localStorage['From'] = 'ClientesVentas';
          localStorage['ClientePedido'] = Cliente;
          window.location.assign('SeleccionPedido.html');
      }
 
</script>

<body>

         <div data-role="page" data-theme="c"  id="pageventas">

	        <div data-role="header">
	            <a href="index.html" data-icon="delete">Cancel</a>
	            <h1>Clientes</h1>
	            <a href="javascript:GotoSeleccionPedido();" data-icon="check" data-theme="b" data-ajax="false">Selección Pedido</a>
            </div>

            <div data-role="navbar">
	            <ul>
		            <li><a href="javascript:window.location.assign('ClientesGeneral.html');" >General</a> </li>
		            <li><a href="javascript:window.location.assign('ClientesVentas.html?);" class="ui-btn-active ui-state-persist">Ventas</a></li>
                    <li><a href="ClientesCobros.html">Cobros</a></li>
                    <li><a href="ClientesTam.html">Tam</a></li>
                    <li><a href="ClientesAlta.html">Alta Cliente</a></li>
	            </ul>
            </div> 
           

            <div data-role="content"  >	

		         <ul data-role="listview" data-inset="true" id= "lvDatosPedido">
                       <li data-role='list-divider'>Datos Cliente
                       </li>

                       <li id ="liCliente"><div class='container_12'>
                               <div class='grid_4'>Cliente:</div> 
                               <div class='grid_8' id="txtCliente"></div> 
                           </div> 
                        </li> 
                        <li id ="liNombreCliente"><div class='container_12'>
                               <div class='grid_4'>Nombre Cliente:</div> 
                               <div class='grid_8' id="txtNombreCliente"></div> 
                           </div> 
                        </li> 
                       
                <li> 
                  <div class='container_12' data-theme="a">
                         <ul data-role="listview" data-inset="true" id= "lvLineas" data-divider-theme ="c" >

 
                            <li data-role='list-divider' data-mini="true">
                                <div class='container_16'>
                                    <div class='grid_2'>Código</div> 
                                    <div class='grid_5'>Descripción</div> 
                                    <div class='grid_2'>Cantidad</div> 
                                    <div class='grid_2'>PVP</div> 
                                    <div class='grid_1'>Dto.</div> 
                                </div>
                                                     
                        </li> 
                    </ul>
                </div>

                <li data-role='list-divider'>Totales</li>

               <li> 
                     <div class='container_12' data-theme="e">
                         <ul data-role="listview" id="lvTotales" data-inset="true" id= "Ul1" data-theme="e" data-divider-theme="e">

 
                        <li data-role='list-divider'>
                            <div class='container_12'>
                                <div class='grid_2'>Subtotal</div> 
                                <div class='grid_4'>% Dto </div> 
                                <div class='grid_2'>Base</div> 
                                <div class='grid_2'>Impuesto</div> 
                                <div class='grid_2'>Total</div> 
                            </div> 
                        </li> 
                       
                    </div>
                </li>

               </li>

              </div>

               <div data-role="footer"  data-position="fixed" >
                     <div data-role="navbar" data-iconpos="top">
                          <ul>
                             <li><a href="javascript:window.location.assign('VentasInicio.html');"  data-icon="plus" data-prefetch="true"  >Ventas/Visitas</a></li>
                             <li><a href="javascript:window.location.assign('RuteroMenu.html');"  data-icon="back" >Rutero</a></li>
                             <li><a href="javascript:window.location.assign('Articulos.html');"  data-icon="back" >Articulos</a></li>
                             <li><a href="javascript:window.location.assign('HerramientasMenu.html');"  data-icon="back" >Herramientas</a></li>
                            </ul>                
                    </div>
                </div>

         </div>
</body>
</html>

