
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" >
   <meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>

    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery-mobile-960.min.css" />
    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery.mobile-1.1.0.min.css" />
    <link rel="stylesheet" type="text/css" href="jquery.mobile-1.1.0/jquery.mobile.simpledialog.min.css" /> 

    <script src="jquery.mobile-1.1.0/jquery-1.7.1.min.js"></script>
    <script src="jquery.mobile-1.1.0/jquery.mobile-1.1.0.min.js"></script>
    <script type="text/javascript" src="jquery.mobile-1.1.0/jquery.mobile.simpledialog2.min.js"></script>

    <script language="javascript" type="text/javascript" src="SBODatabase.js"></script>


</head>

 <script language="javascript" type="text/javascript">

     var myDB;
     var PedidosPendientes, VisitasPendientes, LeadsPendientes;
     var PedidosExportar;
     var TotalPedidosPendientes = 0;
     var CheckClicked = false;



     $("#exportvisitas").live("pageinit", function (event) {

         myDB = OpenDatabase(successfunction, errorfunction);

         $('#toptitle').text("Exportar Visitas");

         RefreshPendientes();
         RefreshPedidosPendientes();

     });

     function RefreshAll() {
         RefreshPendientes();
         RefreshPedidosPendientes();
         $.mobile.hidePageLoadingMsg();
     }

     function RefreshPendientes() {

         VisitasPendientes = "Visitas (0)";
         PedidosPendientes = "Pedidos (0)";
         LeadsPendientes = "Leads (0)";

         myDB.transaction(function (tx) {

             tx.executeSql("select COUNT(*) AS Total FROM AX_VISITAS WHERE Send=?", [0], function (tx, result) {
                 VisitasPendientes = "Visitas (" + result.rows.item(0)['Total'].toString() + ")";
                 TotalPedidosPendientes = result.rows.item(0)['Total'];
                 $('#countVisitas').text(VisitasPendientes);
             });
         });

             myDB.transaction(function (tx) {

                 tx.executeSql("select COUNT(*) AS Total FROM AX_ORDR WHERE Send=?", [0], function (tx, result) {
                     PedidosPendientes = "Pedidos (" + result.rows.item(0)['Total'].toString() + ")";
                     $('#countPedidos').text(PedidosPendientes);
                 });
             });

             //$('#countLeads').text("Leads (" + LeadsPendientes.toString() + ")" );
     }

     function RefreshPedidosPendientes() {
         var sTextDiscount, dQuantity, dPrice, dDiscount, dTotalLinea;
         var iLine;
         var sId,sCliente,sNombre,sFecha,sHora

         $.mobile.loadingMessageTextVisible = true;
         $.mobile.showPageLoadingMsg("a", "Inicializando Lineas...", false);

         myDB.transaction(function (tx) {

             tx.executeSql("select T0.*,T1.CardName from AX_VISITAS T0 LEFT OUTER JOIN AX_OCRD T1 ON T0.CardCode = T1.CardCode WHERE T0.Send=?", [0], function (tx, result) {
                 dataset = result.rows;

                 PedidosExportar = new Array(result.rows.length);

                 $('#lvVisitas').empty();
                 $("#lvVisitas").append('<li data-role="list-divider"><div class="container_12"><div class="grid_1">Exp.</div><div class="grid_1">Visita</div><div class="grid_2">Cliente</div><div class="grid_4">Nombre</div><div class="grid_2">Fecha</div><div class="grid_2">Hora</div></div></li>');
                 for (var i = 0; i < result.rows.length; i++) {

                     iLine = i + 1;
                     sId = ""; sCliente = ""; sNombre = ""; sFecha = ""; sHora = "";

                     if (result.rows.item(i)['Id'] != null)
                         sId = result.rows.item(i)['Id'].toString();
                     if (result.rows.item(i)['CardCode'] != null)
                         sCliente = result.rows.item(i)['CardCode'].toString();
                     if (result.rows.item(i)['CardName'] != null)
                         sNombre = result.rows.item(i)['CardName'].toString();
                     if (result.rows.item(i)['CreateDate'] != null)
                         sFecha = result.rows.item(i)['CreateDate'].toString();
                     if (result.rows.item(i)['CreateTime'] != null)
                         sHora = result.rows.item(i)['CreateTime'].toString();

                     PedidosExportar[i] = new Array(2);
                     PedidosExportar[i][0] = sId;
                     PedidosExportar[i][1] = 0;


                     $("#lvVisitas").append('<li><div class="container_12"><div class="grid_1"><a href="#" onclick="javascript:SetCheckPedido(event,' + iLine.toString() + ' )"><img id="img' + iLine.toString() + '" src="images/nocheck.png" alt="France" style = "padding-left:10px; padding-bottom:2px;" /></a> </div><div class="grid_1">' + sId.toString() + '</div><div class="grid_2">' + sCliente.toString() + '</div><div class="grid_4">' + sNombre + '</div><div class="grid_2">' + sFecha.toString() + '</div><div class="grid_2">' + sHora.toString() + '</div></div></li>');
  
                 }
                 $('#lvVisitas').listview('refresh', true);
                 $("#exportvisitas").trigger("create");

             });
         });
     }

  

     function ShowPedido(iPedido) {

         window.location.href = "VentasPedidoEdit.html?Pedido=" + iPedido.toString();
     }
     function SetCheckPedido(event, iLinea) {

         event.preventDefault();
         event.stopPropagation();
         CheckClicked = true;

         if ($('#img' + iLinea.toString()).attr('src') == 'images/check.png') {
             $('#img' + iLinea.toString()).attr('src', 'images/nocheck.png');
             PedidosExportar[iLinea - 1][1] = 0;
         }
         else {
             $('#img' + iLinea.toString()).attr('src', 'images/check.png');
             PedidosExportar[iLinea - 1][1] = 1;
         }

         return false;
     }

     function CheckPedido(iLinea) {
         $('#img' + iLinea.toString()).attr('src', 'images/check.png');
         PedidosExportar[iLinea - 1][1] = 1;
         return false;
     }

     function UncheckPedido(iLinea) {
         $('#img' + iLinea.toString()).attr('src', 'images/nocheck.png');
         PedidosExportar[iLinea - 1][1] = 0;
         return false;
     }

     $(document).delegate('#CheckAll', 'click', function () {
         var i;

         for (i = 1; i <= $('#lvVisitas').children("li").length; i++) {
             CheckPedido(i)
         }
     })

     $(document).delegate('#UncheckAll', 'click', function () {
         var i;

         for (i = 1; i <= $('#lvVisitas').children("li").length; i++) {
             UncheckPedido(i)
         }
     })

     $(document).delegate('#Export', 'click', function () {
         var i;
         var sXml;
         var iCount = 0;
         var iPedido = 0;
         var sSelectPedidos = "";

         if (window.navigator.onLine== false) {
             alert("No es posible realizar la exportación. No dispone de conexión.");
             return;
         }


         xmldata = "<NewDataSet>";

         for (i = 0; i < TotalPedidosPendientes; i++) {
             if (PedidosExportar[i][1] == 1) {
                 iCount++;
                 sSelectPedidos += (PedidosExportar[i][0] + ",");
             }
         }

         if (iCount == 0) {
             alert("Debe seleccionar las Visitas a exportar.");
             return;
         }

         sSelectPedidos = sSelectPedidos.substring(0, sSelectPedidos.length - 1);

         if (!confirm('Desea exportar las visitas Seleccionados?'))
             return;

         showProcess("Exportando Visitas...");

         myDB = OpenDatabase(successfunction, errorfunction);

         myDB.transaction(function (tx) {

             var sSQL = "SELECT * FROM AX_VISITAS WHERE Id IN (" + sSelectPedidos + ")";
             tx.executeSql(sSQL, [], function (tx, result) {
                 dataset = result.rows;

                 if (result.rows.length > 0) {

                     for (var j = 0; j < result.rows.length; j++) {

                         xmldata += "<VISITA>";
                         xmldata += "<Id>" + result.rows.item(j)['Id'].toString() + "</Id>";
                         xmldata += "<SlpCode>" + result.rows.item(j)['SlpCode'].toString() + "</SlpCode>";
                         xmldata += "<CardCode>" + result.rows.item(j)['CardCode'].toString() + "</CardCode>";
                         xmldata += "<CreateDate>" + result.rows.item(j)['CreateDate'].toString() + "</CreateDate>";
                         xmldata += "<CreateTime>" + result.rows.item(j)['CreateTime'].toString() + "</CreateTime>";
                         xmldata += "<Pedido>" + result.rows.item(j)['Pedido'].toString() + "</Pedido>";
                         xmldata += "<Motivo>" + result.rows.item(j)['Motivo'].toString() + "</Motivo>";
                         xmldata += "<Modo>" + result.rows.item(j)['Modo'].toString() + "</Modo>";

                         if (result.rows.item(j)['Comments'] != null)
                             xmldata += "<Comments>" + result.rows.item(j)['Comments'].toString() + "</Comments>";
                         else
                             xmldata += "<Comments></Comments>";

                         xmldata += "</VISITA>";
                     }

                     //UpdateVisitsSend(sSelectPedidos, GotoExport, errorfunction);
                     GotoExport();
                 }
                 else {
                     alert("No existen Visitas pendientes de exportar");
                     $.mobile.hidePageLoadingMsg();
                 }

             });

         });

     })

     function showProcess(sMsg) {
         $.mobile.loadingMessageTextVisible = true;
         $.mobile.showPageLoadingMsg("a", sMsg, false);
     }

     function GotoExport() {
         xmldata += "</NewDataSet>";

         xmlhttp = new XMLHttpRequest();
         xmlhttp.onreadystatechange = statuschange;
         xmlhttp.open("POST", "ExportacionVisitas.aspx", true);
         xmlhttp.setRequestHeader('Content-Type', 'text/xml')
         xmlhttp.send(xmldata);

//         setTimeout(alert("Se han exportado correctamente las Visitas seleccionados"), 30000);

//         setTimeout(RefreshAll, 1000);
     }



     // ----------------------------------------------------------------------------------------
     // statuschange
     // callback del procés de importació xml
     // ----------------------------------------------------------------------------------------
     function statuschange() {
         var sDate = "";
         var sTotal = "";

         if (xmlhttp.readyState == 4) {
             if (xmlhttp.status == 200) {

                 var sInsertPedidos = xmlhttp.responseText;

                 if (sInsertPedidos.toString() == "")
                     alert("Error en la exportación de Visitas");
                 else {
                     UpdateVisitsSend(sInsertPedidos, endfunction(sInsertPedidos), errorfunction);
                 }

                 $.mobile.hidePageLoadingMsg();

             } else {
                 alert("Error exportación : " + xmlhttp.statusText + "\nHTTP status code: " + xmlhttp.status);
             }
         }
     }

     function endfunction(sInsertPedidos) {

         setTimeout(alert("Se han exportado correctamente las Visitas seleccionados " + sInsertPedidos), 1000);

         setTimeout(RefreshAll, 1000);
     }

     function successfunction() {
         $.mobile.hidePageLoadingMsg();
     }

     function errorfunction(e) {
         if (e == DOMException.INVALID_STATE_ERR) {

             alert("Invalid database version.");
         } else {
             alert("Unknown error " + e + ".");
         }
         $.mobile.hidePageLoadingMsg();
     }
</script>

<body>



         <div data-role="page" data-theme="c" id="exportvisitas">

	         <div data-role="header">
	            <a href="javascript:window.location.assign('index.html');" data-icon="home">Inicio</a>
	            <h1 id="toptitle">Exportar</h1>
            </div>

           <div data-role="navbar">
	            <ul>
		            <li><a href="javascript:window.location.assign('HerramientasExportPedidos.html');" data-ajax="false"><div id ="countPedidos">Pedidos (0)</div></a></li>
                    <li><a href="javascript:window.location.assign('HerramientasExportVisitas.html');" data-ajax="false"class="ui-btn-active ui-state-persist"><div id ="countVisitas">Visitas (0)</div></a></li>
                    <li><a href="javascript:window.location.assign('HerramientasExportLeads.html');" data-ajax="false"><div id ="countLeads">Leads (0)</div></a></li>
	            </ul>
            </div>

	        <div data-role="content">	

                         <ul data-role="listview" data-inset="true" id= "lvVisitas" data-theme ="c" data-divider-theme ="a" data-mini="true" >

                               
                         </ul>

                  <ul data-role="listview" data-inset="true" id= "Ul2">
                    <li class="ui-body ui-body-b">
				        <fieldset class="ui-grid-b">
						        <div data-theme="b" class="ui-block-a"><button id="CheckAll" data-theme="d">Marcar todo</button></div>
						        <div data-theme="c" class="ui-block-b"><button id="UncheckAll" data-theme="d">Desmarcar todo</button></div>
                                <div data-theme="c" class="ui-block-c"><button  id="Export" data-theme="a" >Exportar</button></div>
			            </fieldset>
			        </li>

			    </ul>
            </div> 

               <div data-role="footer"  data-position="fixed" >
                    <div data-role="navbar" data-iconpos="top">
                        <ul>
                            <li><a href="javascript:window.location.assign('RuteroMenu.html');"  data-icon="back" >Rutero</a></li>
                            <li><a href="javascript:window.location.assign('VentasInicio.html');"  data-icon="plus" data-prefetch="true"  >Ventas/Visitas</a></li>
                            <li><a href="javascript:window.location.assign('ClientesGeneral.html');"  data-icon="back" >Interlocutores</a></li>
                            <li><a href="javascript:window.location.assign('Articulos.html');"  data-icon="back" >Articulos</a></li>
                        </ul>                
                </div>

         </div>

</body>
 
 

</html>