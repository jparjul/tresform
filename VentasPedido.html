
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" >
    

<meta name="apple-mobile-web-app-capable" content="yes" />
   <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>


    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery-mobile-960.min.css" />
    <link rel="stylesheet" href="jquery.mobile-1.1.0/jquery.mobile-1.1.0.min.css" />

    <script src="jquery.mobile-1.1.0/jquery-1.7.1.min.js"></script>
    <script src="jquery.mobile-1.1.0/jquery.mobile-1.1.0.min.js"></script>
    

    <script language="javascript" type="text/javascript" src="SBODatabase.js"></script>




</head>
 <script language="javascript" type="text/javascript">

     var myDB;
     var Cliente;
     var Visita;
     var Pedido;
     var Preguntas;
 


     $("#pedido1").live("pageinit", function (event) {

         myDB = OpenDatabase(successfunction, errorfunction);

         Cliente = localStorage["Cliente"];
         Visita = localStorage["Visita"];

        $('#toptitle').text("Pedido Visita " + Visita.toString());


        RefreshDatosCliente();
        InitializeBenchmark();
        InitializePromociones();
        InitializeAddresses();


     });

     

     function RefreshDatosCliente() {
         myDB.transaction(function (tx) {

             tx.executeSql("SELECT * FROM AX_OCRD WHERE CardCode = ?", [Cliente], function (tx, result) {
                 dataset = result.rows;

                 var sInitText = "<li><div class='container_12'><div class='grid_4'>";
                 var sMidText = "</div><div class='grid_8'>";
                 var sEndText = "</div></div></li>";

                 var sText = "";
                 sText = sInitText + "Cliente:" + sMidText + result.rows.item(0)['CardCode'] + sEndText;
                 $("#liCliente").empty();
                 $("#liCliente").append(sText);

                 sText = sInitText + "Nombre Cliente:" + sMidText + result.rows.item(0)['CardName'] + sEndText;
                 $("#liNombreCliente").empty();
                 $("#liNombreCliente").append(sText);

             });
          });
     }

     function InitializeBenchmark() {
         myDB.transaction(function (tx) {

             tx.executeSql("SELECT * FROM AX_PREGUNTAS ", [], function (tx, result) {
                 dataset = result.rows;

                 Preguntas = new Array(dataset.length);

                 for (var i = 0; i < dataset.length; i++) {
                     var sId = 'pregunta-' + result.rows.item(i)['Id'].toString();
                     var sName = result.rows.item(i)['Pregunta'].toString();

                     $("#lvDatosPedido").append('<li data-role="fieldcontain"><label for="' + sName + '">' + sName + '</label><input id="' + sName + '" type="text"></li>');

                     Preguntas[i] = sName;
                 }
                 $('#lvDatosPedido').listview('refresh', true);
                 $("#pedido1").trigger("create");
             });
         });
     }


     function InitializePromociones() {
         myDB.transaction(function (tx) {

             tx.executeSql("SELECT * FROM AX_PROMOS WHERE CardCode = ?", [Cliente], function (tx, result) {
                 dataset = result.rows;

                 $("#groupPromociones").empty();
                 $("#groupPromociones").append("<legend>Promociones:</legend>");
 
                 for (var i = 0; i < dataset.length; i++) {

                     var sId = "check-" + result.rows.item(i)['Id'];
                     var sName =  result.rows.item(i)['DescPromo'];

                     $("#groupPromociones").append('<label for="c' + sId + '">' + sName + '</label><input id="c' + sId + '" type="checkbox">');

                 }
                 $('#lvDatosPedido').listview('refresh', true);
                 $("#pedido1").trigger("create");

             });
         });
     }

     function InitializeAddresses() {
         myDB.transaction(function (tx) {

             tx.executeSql("SELECT Address FROM AX_CRD1 WHERE CardCode = ? ORDER BY Address", [Cliente], function (tx, result) {
                 dataset = result.rows;

                 var sText = "";

                 sText = "<option value='0' data-placeholder='true'>Seleccione la direccion de entrega...</option>";

                 for (var i = 0; i < dataset.length; i++) {
                     var sAddress = result.rows.item(i)['Address'];

                     if (dataset.length == 1)
                         sText += "<option value='" + sAddress + "' selected='true'>" + sAddress + "</option>";
                     else
                         sText += "<option value='" + sAddress + "'>" + sAddress + "</option>";
                 }
                 $("#selectDireccion").html(sText).selectmenu('refresh', true);
             });
         });
     }

     $(document).delegate('#buttonsave', 'click', function () {

         if (Cliente == null) {
             alert("Debe seleccionar un Cliente.");
             return;
         }

         //if (confirm("Desea guardar los datos del Pedido ?", "Ferrer"))
             SavePedido();

        
     })

     function SavePedido() {

         try {
             myDB.transaction(
                    function (transaction) {

                        $.mobile.loadingMessageTextVisible = true;
                        $.mobile.showPageLoadingMsg("a", "Generando Pedido...", false);

                        var sAddress = $("#selectDireccion option:selected").text();
                        //var sModo = $("#selectModo option:selected").val();
                        var i = 0;
                        var sRespuesta;

                        if (sAddress == "0") sAddress = "";
                        //if (sModo == "0") sModo = "";

                        transaction.executeSql("INSERT INTO AX_ORDR (IdVisita,CardCode,Address,DueDate ) VALUES  (?, ?, ?,date('now','+1 day'))", [Visita, Cliente, sAddress],
                            nullDataHandler, errorHandler);

                        transaction.executeSql("INSERT INTO AX_VISITAS_PREGUNTAS (IdVisita,CardCode,Pregunta,Respuesta1) SELECT ?,?,Pregunta,'' FROM AX_PREGUNTAS", [Visita, Cliente],
                            nullDataHandler, errorHandler);


                        for (i = 0; i < Preguntas.length; i++) {
                            //sRespuesta = $("#" + Preguntas[i]).text();
                            sRespuesta = document.getElementById(Preguntas[i]).value;
                            transaction.executeSql("UPDATE AX_VISITAS_PREGUNTAS SET Respuesta1= ? WHERE IdVisita = ? AND Pregunta = ?", [sRespuesta, Visita, Preguntas[i]],
                            nullDataHandler, errorHandler);
                        }

                        

                        transaction.executeSql("SELECT MAX(Id) AS Ultima FROM AX_ORDR", [], function (tx, result) {

                            localStorage['Cliente'] = Cliente;
                            localStorage['Visita'] = Visita;
                            localStorage['Pedido'] = result.rows.item(0)['Ultima'];
                           // localStorage['Action'] = 1;

                            
                           window.location.assign("VentasLineas.html");

                        }, errorHandler);

                        


                    }
             );
  
         }
         catch (e) {
             errorfunction(e);
         }
     }

     function GotoLineas() {
         $.mobile.hidePageLoadingMsg();
         window.location.assign("VentasLineas.html");
     }

     function queryString(parameter) {
         var loc = location.search.substring(1, location.search.length);
         var param_value = false;
         var params = loc.split("&");
         for (i = 0; i < params.length; i++) {
             param_name = params[i].substring(0, params[i].indexOf('='));
             if (param_name == parameter) {
                 param_value = params[i].substring(params[i].indexOf('=') + 1)
             }
         }
         if (param_value) {
             return param_value;
         }
         else {
             return null; //Here determine return if no parameter is found
         }
     }

     

     function successfunction() {
         $.mobile.hidePageLoadingMsg();
     }

     function errorHandler(transaction, error) {
         alert(error.message + ' (Code ' + error.code + ')');
         return true;
     }

     function nullDataHandler(transaction, results) {
     }

     function errorfunction(e) {
         if (e == DOMException.INVALID_STATE_ERR) {

             alert("Invalid database version.");
         } else {
             alert("Unknown error " + e + ".");
         }
         $.mobile.hidePageLoadingMsg();
     }

     function GotoMenu(sLink) {
         if (confirm("Desea abandonar la edición del Pedido ?", "Ferrer"))
             window.location.assign(sLink);
     }

   
</script>

<body>

         <div data-role="page" data-theme="c"  id="pedido1" class="type-interior">

	        <div data-role="header">
	            <a data-rel="back" data-icon ="back" data-transition ="slide">Anterior</a>
	            <h1 id="toptitle">Ventas Pedido</h1>
                <a href="javascript:window.location.assign('index.html');" data-icon="home">Inicio</a>
            </div>

 

	            <div data-role="content"  >	


		            <ul data-role="listview" data-inset="true" id= "lvDatosPedido">
                       <li data-role='list-divider'>Datos Cliente
                       </li>

                       <li id ="liCliente"><div class='container_12'>
                               <div class='grid_4'>Cliente:</div> 
                               <div class='grid_8'></div> 
                           </div> 
                        </li> 
                        <li id ="liNombreCliente"><div class='container_12'>
                               <div class='grid_4'>Nombre Cliente:</div> 
                               <div class='grid_8'></div> 
                           </div> 
                        </li> 
                       
                <li data-role='list-divider'>Pedido</li>

<!--
                <li data-role="fieldcontain" id="Li1" >
                    <label for="selectModo" class="select">Modo de Pedido:</label>
		            <select name="selectModo" id="selectModo" data-native-menu="false">
			            <option value="0" data-placeholder='true'>Seleccione el modo de Pedido...</option>";
				        <option value="Teléfono" >Teléfono</option>
				        <option value="Visita">Visita</option>
				        <option value="E-Mail">E-Mail</option>
				        <option value="Correo">Correo</option>
                        <option value="E-Commerce">E-Commerce</option>
			        </select>
                </li>
-->

			
            <li id = "list1" data-role="fieldcontain" >
	            <fieldset data-role = "controlgroup" id= "groupPromociones" >
                

	            </fieldset>
           </li>

               <li data-role="fieldcontain" id="direcciones" >
                <label for="selectDireccion" class="select">Dirección de Entrega:</label>
		                <select name="selectDireccion" id="selectDireccion" data-native-menu="false">

		                </select>
             </li>
            
                   <li data-role='list-divider'>Benchmark</li>

 

			  </ul>

              <ul data-role="listview" data-inset="true" id= "Ul2">
                    <li class="ui-body ui-body-b">
				        <fieldset class="ui-grid-a">
						        <div data-theme="b" class="ui-block-a"><button   data-theme="d">Cancelar</button></div>
						        <div data-theme="b" class="ui-block-b"><button id="buttonsave" data-theme="a">Guardar</button></div>
			            </fieldset>
			        </li>

			    </ul>

             </div> 
        

                <div data-role="footer"  data-position="fixed" >
                     <div data-role="navbar" data-iconpos="top">
                          <ul>
                             <li><a href="javascript:GotoMenu('RuteroMenu.html');"  data-icon="plus" data-prefetch="true"  >Rutero</a></li>
                             <li><a href="javascript:GotoMenu('ClientesGeneral.html');"  data-icon="back" >Interlocutores</a></li>
                             <li><a href="javascript:GotoMenu('Articulos.html');"  data-icon="back" >Articulos</a></li>
                             <li><a href="javascript:GotoMenu('HerramientasMenu.html');"  data-icon="back" >Herramientas</a></li>
                            </ul>                
                    </div>
                </div>

         </div>

    
</body>
</html>
